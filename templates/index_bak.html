<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>授权生成简易版</title>
</head>
<body>
<!DOCTYPE html>
    <title>授权字符串生成器</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px auto; max-width: 800px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input { padding: 8px; width: 100%; }
        button { padding: 8px 15px; margin-right: 5px; }
        .result { margin-top: 20px; }
        table { width: 100%%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .pgp-message {
            word-break: break-all;
            white-space: pre-wrap;
            max-width: 600px;
            overflow-x: auto;
        }
        .action-buttons { margin-top: 5px; }
        .copied-message { color: green; margin-top: 5px; display: none; }
    </style>
</head>
<body>
    <h2>生成授权字符串</h2>
    <form method="post" action="/permit" id="permitForm">
        <div class="input-group">
            <label>架构类型：</label>
            <select name="arch" required>
            <option value="X86">X86</option>
            <option value="ARM">ARM</option>
            <option value="LOONGARCH64">LOONGARCH64</option>
            </select>
        </div>
        <div class="input-group">
    <label>集群ID：</label>
    <input type="text" name="cluster_id" required > <!-- 默认集群ID -->
</div>
<div class="input-group">
    <label>节点数：</label>
    <input type="text" name="numNodes" required value="5"> <!-- 默认节点数 -->
</div>
<div class="input-group">
    <label>证书有效时长（天）：</label>
    <input type="text" name="length" required value="30"> <!-- 默认365天 -->
</div>
<div class="input-group">
    <label>cpu数：</label>
    <input type="text" name="numCPUs" required value="10"> <!-- 默认8核 -->
</div>
<div class="input-group">
    <label>arstor存储cpu数：</label>
    <input type="text" name="numArstorCPUs" required value="10"> <!-- 默认4核 -->
</div>
<div class="input-group">
    <label>arstor存储节点数：</label>
    <input type="text" name="numArstorNodes" required value="5"> <!-- 默认2节点 -->
</div>
<div class="input-group">
    <label>运维服务有效期（天）：</label>
    <input type="date" name="cert_start_date" required value="2026-12-31"> <!-- 默认日期 -->
</div>
        <button type="submit" form="permitForm">生成</button>

        {% if result %}
        <div class="result">
            <h3>授权结果：</h3>
            <table>
                <thead>
                    <tr>
                        <th>字段</th>
                        <th>值</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in result.items() %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>
                        {% if key == 'pgp_message' %}
                            <div class="pgp-message">{{ value|safe }}</div>
                             <div class="action-buttons">
                                <button type="button" onclick="copyPGP(event, '{{ value|tojson|forceescape }}')">复制</button>
                                <button type="button" onclick="downloadPGP(event, '{{ value|tojson|forceescape }}')">下载.key</button>
                            </div>
                            <div id="copiedMessage" class="copied-message"></div>
                            {% else %}
                            {{ value }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </form>

    <script>
        function copyPGP(event, pgpText) {
            try {
                console.log('复制内容:', pgpText);

                // 创建临时textarea元素
                const textArea = document.createElement('textarea');

                // 特殊处理：去除JSON转义添加的引号
                const cleanText = pgpText.replace(/^\"|\"$/g, '');

                textArea.value = cleanText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                // 显示复制成功消息
                const messageElement = event.target.closest('tr').querySelector('.copied-message');
                messageElement.style.display = 'block';
                messageElement.textContent = '内容已复制到剪贴板！';
                setTimeout(() => { messageElement.style.display = 'none'; }, 2000);

            } catch (error) {
                console.error('复制过程中发生错误:', error);
                alert('复制失败: ' + error.message);
            }
        }

        function downloadPGP(event, pgpText) {
            try {
                console.log('下载内容:', pgpText);

                // 特殊处理：去除JSON转义添加的引号
                const cleanText = pgpText.replace(/^\"|\"$/g, '');

                const filename = `license_${new Date().getTime()}.key`;

                // 创建Blob对象时使用原始内容
                const blob = new Blob([cleanText], {type: 'application/pgp-keys'});
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('下载过程中发生错误:', error);
                alert('下载失败: ' + error.message);
            }
        }
    </script>
</body>
</html>